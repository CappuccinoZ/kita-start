---
import BaseLayout from "./BaseLayout.astro";
import ResourcePanel from "../components/ResourcePanel.astro";
import SearchBox from "../components/SearchBox.astro";

import type { Resource } from "../scripts/resource-type";
interface Props {
  pageTitle: string;
  resources: Resource[];
  search?: boolean;
}
const { pageTitle, resources, search = false } = Astro.props;

const categories = resources.map((resource) => resource.name);
---

<BaseLayout pageTitle={pageTitle} categories={categories}>
  {
    search ? (
      <SearchBox />
    ) : (
      <h2 class="text-2xl mt-10 mb-4 text-center font-semibold text-secondary-content text-shadow-md">
        {pageTitle}
      </h2>
    )
  }

  <div class="flex">
    <div class="flex-none mr-6 pt-10 hidden lg:block">
      {
        categories && categories.length > 0 && (
          <ul class="menu sticky top-26 bg-base-100 rounded-box w-50">
            <li class="menu-title">分类</li>
            {categories.map((category) => (
              <li>
                <a class="menu-item" href={"#" + category}>
                  {category}
                </a>
              </li>
            ))}
          </ul>
        )
      }
    </div>

    <div class="flex-1">
      {resources.map((resource) => <ResourcePanel resource={resource} />)}
    </div>
  </div>
</BaseLayout>

<script>
  const menuItems = document.querySelectorAll(
    ".menu-item",
  ) as NodeListOf<HTMLAnchorElement>;

  const observer = new IntersectionObserver(
    (entries) => {
      const activeEntry = entries.find((e) => e.isIntersecting);
      if (!activeEntry) return;

      menuItems.forEach((item) => {
        item.classList.toggle(
          "menu-active",
          item.href === `#${activeEntry.target.id}`,
        );
      });
    },
    { rootMargin: "0px 0px -70% 0px" },
  );

  document
    .querySelectorAll(".resource-panel h2[id]")
    .forEach((h2) => observer.observe(h2));
</script>
